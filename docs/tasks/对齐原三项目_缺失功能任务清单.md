# 对齐原三项目：缺失/不一致功能任务清单

> 目的：把 `web_analyzer_v2` 与“原始三个开源项目/三合一目标”能力对齐，避免只做框架或 MVP。
>
> 说明：
> - 本清单仅列出 **仍缺失/明显阉割/需要较大改动** 的事项；已在其它清单完成并勾选的内容不重复写。
> - 任务以 `- [ ]` 形式列出，便于逐项验收与打勾。

---

## 前端（Frontend）

### 导航与入口对齐
- [x] 为 `/workbench`（AnalysisWorkbench）增加菜单入口与使用说明（当前路由存在但无任何 UI 入口，等于没做）。

### 请求录制/重放（request-analysis）
- [ ] 录制来源拓展：除 Proxy 之外，支持选择/导入 Crawler/Native Hook 会话的请求（当前偏向“Proxy 内存窗口快照”）。
- [ ] 调用栈展示增强：当存在 js-injection / crawler / hook 的调用栈时，在 RequestRecorder 中提供可折叠展示、脚本定位（文件名/行列/片段）。
- [x] 大包/二进制体验补齐：当 body/response 为 artifact 引用时，提供“下载/预览(hex/文本)”入口（当前仅显示字符串，artifact 看不到）。

### AI/命令系统（若要对齐 AI CLI Web/CLI 能力）
- [ ] 增加“AI 工作区”页面入口（路由 + 侧边栏/首页快捷入口），整合：`CommandInput`、会话统计、`SessionCompression`、`InteractiveFileTree`、`ProjectInitializer` 等（当前组件存在但无入口/不在路由中）。
- [ ] 命令结果消费：根据 `/api/v1/commands/execute` 返回的 `data.action` 真正打开对应面板/执行对应流程（目前后端多为 `open_*`，前端缺少落地动作链路）。
- [ ] MCP/Agents 交互闭环：提供 MCP server 管理、tool 执行结果入会话；提供 Agent 列表/切换/创建并与当前会话绑定（当前缺少可用入口与完整闭环）。

### 高级抓包能力（若原项目包含“拦截/修改/断点调试”）
- [ ] 新增“请求拦截/修改（Breakpoints）”页面：规则配置、命中暂停、在线编辑请求/响应并放行（与 Proxy/HAR/重放联动）。

### 移动端 Native Hook（若原项目包含）
- [ ] 增加移动端 Hook 页面入口与“仅在 pinning/自定义证书存储场景启用”的风险提示与向导（当前仅有文档与诊断，缺少可操作链路）。

---

## 后端（Backend）

### 认证（Qwen OAuth）
- [ ] 实现真实的 Qwen OAuth：`token exchange / userinfo / refresh / revoke`（`AuthService` 当前为模拟；当配置 `QWEN_CLIENT_ID` 等信息时应走真实 API）。
- [ ] 增加 OAuth 配置自检：redirect_uri 不匹配、client_secret 缺失、网络失败等给出可执行提示（避免静默走 mock 导致“看似成功但不可用”）。

### 命令系统 / MCP / Agents（若要对齐 AI CLI 能力）
- [ ] `CommandService`：补齐 `/mcp /agents /directory /init /settings` 等命令的真实后端逻辑（目前多为仅返回 `open_*` 的占位动作）。
- [ ] 增加 MCP API：`/api/v1/mcp/*`（connect/list tools/execute），并实现安全的工具调用（白名单/沙箱/资源访问边界）。
- [ ] 增加 Agents API：`/api/v1/agents/*`（list/switch/create/info），支持持久化与会话绑定。
- [ ] 明确并落地 session_id 生命周期与存储（目前大量使用 `session_id='current'`；需要与 UI/终端会话对齐，避免数据串线）。

### request-analysis（录制/重放）
- [ ] 将 request-analysis 快照持久化：`data/request_analysis/<recording_id>/requests.json + manifest`，并提供下载/export（当前主要为内存快照）。
- [ ] 调用栈关联：从 `js-injection` events / crawler call_stack / hook records 中按 `request_id` 反查并写入 request-analysis 记录（避免“调用栈为空/靠猜”）。

### 高级抓包能力（若原项目包含）
- [ ] Proxy 侧实现断点/改包：拦截规则系统 + mitmproxy addon 集成 + 超时/放行策略 + 审计日志（与前端 Breakpoints 页面配套）。

### 移动端 Native Hook（若原项目包含）
- [ ] Android/iOS Hook 方案落地：设备发现、Frida server 管理（或外部接入）、脚本下发、记录落库、与 proxy_session 关联（用于证书固定/应用层加密定位）。

### 稳定性/工程化（避免“看似可用，实测崩/丢数据”）
- [ ] `HybridStorage`（JSON）并发写入加锁/原子写，避免多请求并发/崩溃导致数据损坏（生产与长期运行必需）。
- [ ] Crawler HAR 导出升级：补齐 request/response headers/body、timings、redirect、content（当前 `trace.har` 为简化版，可能导致对齐不足）。

---

## 环境/依赖（影响对齐验证）

- [ ] Linux/CI 环境补齐 Playwright 运行依赖（如 `libnspr4` 等）并提供一键安装脚本，保证 `scripts/crawler_smoke.py` 可端到端跑通。
