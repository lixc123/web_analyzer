# 多平台网络请求录制系统架构文档

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层 (React)                         │
├─────────────────────────────────────────────────────────────┤
│  ProxyCapture Page                                           │
│  ├─ ProxyControl (代理控制)                                  │
│  ├─ MobileSetup (移动端配置)                                 │
│  ├─ CertManager (证书管理)                                   │
│  ├─ ProxyStatus (状态显示)                                   │
│  └─ DeviceList (设备列表)                                    │
└─────────────────────────────────────────────────────────────┘
                            ↓ HTTP/WebSocket
┌─────────────────────────────────────────────────────────────┐
│                    后端层 (FastAPI)                          │
├─────────────────────────────────────────────────────────────┤
│  API Routes                                                  │
│  ├─ /api/v1/proxy/* (代理控制接口)                          │
│  ├─ /api/v1/filters/* (过滤规则接口)                        │
│  └─ /ws/proxy-events (WebSocket 实时推送)                   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    服务层 (Services)                         │
├─────────────────────────────────────────────────────────────┤
│  ProxyServiceManager (单例)                                  │
│  ├─ ProxyServer (mitmproxy 封装)                            │
│  ├─ RequestInterceptor (请求拦截)                           │
│  ├─ RequestFilter (过滤引擎)                                │
│  ├─ RequestStatistics (统计)                                │
│  ├─ CertManager (证书管理)                                  │
│  ├─ WindowsSystemProxy (系统代理)                           │
│  ├─ WindowsFirewall (防火墙)                                │
│  └─ DeviceDetector (设备识别)                               │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    数据层 (Storage)                          │
├─────────────────────────────────────────────────────────────┤
│  RequestStorage (内存存储)                                   │
│  └─ UnifiedRequest (统一数据模型)                           │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                  核心代理引擎 (mitmproxy)                    │
├─────────────────────────────────────────────────────────────┤
│  HTTP/HTTPS Proxy Server                                     │
│  ├─ SSL/TLS 拦截                                            │
│  ├─ 请求/响应处理                                           │
│  └─ Addon 机制                                              │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    客户端设备                                │
├─────────────────────────────────────────────────────────────┤
│  Windows 桌面应用 | iOS 设备 | Android 设备                 │
└─────────────────────────────────────────────────────────────┘
```

## 模块职责说明

### 前端模块

**ProxyControl (代理控制面板)**
- 代理服务启动/停止
- 配置管理（端口、系统代理、HTTPS 捕获）
- 状态显示和本机 IP 显示

**MobileSetup (移动端配置向导)**
- 平台选择（iOS/Android）
- 二维码生成和显示
- 分步配置说明

**CertManager (证书管理)**
- 证书下载
- Windows 证书安装/卸载
- 多平台安装指南

**ProxyStatus (状态指示器)**
- 实时状态显示
- 连接设备数
- 请求统计

**DeviceList (设备列表)**
- 已连接设备展示
- 设备信息（类型、系统版本）
- 请求数统计

### 后端模块

**ProxyServiceManager (服务管理器)**
- 单例模式，全局唯一实例
- 统一管理所有代理相关服务
- 协调各模块协同工作

**ProxyServer (代理服务器)**
- 基于 mitmproxy 的 HTTP/HTTPS 代理
- 端口冲突自动重试
- 启动/停止/状态管理

**RequestInterceptor (请求拦截器)**
- mitmproxy addon 实现
- 拦截 HTTP/HTTPS 请求和响应
- 调用过滤器和存储服务

**RequestFilter (过滤引擎)**
- 黑白名单规则
- 正则表达式匹配
- 通配符支持

**RequestStatistics (统计模块)**
- 请求总数统计
- 成功/失败率
- 域名访问统计

**CertManager (证书管理)**
- mitmproxy CA 证书管理
- 二维码生成
- Windows 证书安装/卸载
- 移动端安装指南生成

**WindowsSystemProxy (系统代理)**
- Windows 注册表操作
- 系统代理启用/禁用
- 原始设置保存和恢复

**WindowsFirewall (防火墙管理)**
- 防火墙规则检查
- 自动添加入站规则
- 服务停止时自动清理

**DeviceDetector (设备识别)**
- User-Agent 解析
- 设备类型识别（iOS/Android/Windows/macOS/Linux）
- 设备信息提取

**RequestStorage (请求存储)**
- 内存存储实现
- 统一数据模型
- 查询和统计接口

**ProxyEventBroadcaster (事件广播)**
- WebSocket 连接管理
- 实时事件推送
- 新请求通知

## 数据流图

### 请求捕获流程

```
客户端设备
    ↓ HTTP/HTTPS 请求
mitmproxy 代理服务器
    ↓ 拦截
RequestInterceptor (addon)
    ↓ 检查
RequestFilter (过滤规则)
    ↓ 通过
DeviceDetector (设备识别)
    ↓ 识别
RequestStorage (存储)
    ↓ 保存
ProxyEventBroadcaster (广播)
    ↓ WebSocket
前端实时更新
```

### 代理启动流程

```
用户点击启动
    ↓
前端调用 POST /api/v1/proxy/start
    ↓
ProxyServiceManager.start()
    ├─ ProxyServer.start() (启动 mitmproxy)
    ├─ WindowsSystemProxy.enable() (可选)
    └─ WindowsFirewall.add_rule() (可选)
    ↓
返回状态和本机 IP
    ↓
前端更新 UI
```

### 证书安装流程

```
用户请求证书
    ↓
前端调用 GET /api/v1/proxy/cert/download
    ↓
CertManager.get_cert_for_mobile()
    ↓
返回 .cer 证书文件
    ↓
用户在设备上安装
```

## 技术选型说明

### 后端技术栈

**FastAPI**
- 现代化的 Python Web 框架
- 自动生成 API 文档
- 原生支持异步和 WebSocket
- 类型提示和数据验证

**mitmproxy**
- 成熟的 HTTP/HTTPS 代理库
- 强大的 SSL/TLS 拦截能力
- 灵活的 addon 机制
- 跨平台支持

**pywin32**
- Windows API 访问
- 注册表操作
- 系统代理设置

**qrcode**
- 二维码生成
- 支持多种输出格式

### 前端技术栈

**React**
- 组件化开发
- 虚拟 DOM 性能优化
- 丰富的生态系统

**TypeScript**
- 类型安全
- 更好的 IDE 支持
- 减少运行时错误

**Axios**
- HTTP 客户端
- 拦截器支持
- 自动转换 JSON

### 数据存储

**内存存储**
- 快速访问
- 无需额外依赖
- 适合临时数据

**未来扩展：数据库**
- 持久化存储
- 历史数据查询
- 大数据量支持

## 关键设计决策

### 1. 单例模式服务管理器

**原因：**
- 确保全局只有一个代理服务实例
- 避免端口冲突
- 统一管理所有服务状态

### 2. 统一数据模型

**原因：**
- 支持多来源请求（浏览器、桌面、移动端）
- 便于统一处理和展示
- 扩展性好

### 3. WebSocket 实时推送

**原因：**
- 低延迟
- 服务器主动推送
- 减少轮询开销

### 4. 内存存储

**原因：**
- 简化部署
- 快速访问
- 适合实时监控场景

**权衡：**
- 重启后数据丢失
- 内存占用限制

### 5. mitmproxy addon 机制

**原因：**
- 灵活的扩展点
- 不侵入核心代码
- 易于维护

## 性能优化

### 响应体大小限制
- 默认限制 10000 字符
- 避免内存溢出
- 可配置

### 请求过滤
- 减少不必要的处理
- 降低存储压力
- 提高性能

### WebSocket 批量推送
- 减少推送频率
- 降低网络开销
- 提高前端性能

## 安全考虑

### 证书私钥保护
- 仅存储在本地
- 不通过 API 暴露
- 文件权限限制

### 敏感数据脱敏
- Cookie 部分隐藏
- Authorization 头部脱敏
- 密码字段过滤

### 访问控制
- 本地访问限制
- 防火墙规则
- 端口绑定控制

## 扩展性

### 支持的扩展点

1. **新的设备类型识别**
   - 扩展 DeviceDetector

2. **新的存储后端**
   - 实现 RequestStorage 接口

3. **新的过滤规则**
   - 扩展 RequestFilter

4. **新的统计维度**
   - 扩展 RequestStatistics

5. **新的导出格式**
   - 添加导出处理器
